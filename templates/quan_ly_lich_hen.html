{% extends "base.html" %}

{% block title %}Quản lý lịch hẹn{% endblock %}

{% block top_actions %}
  <div class="user-info">
      Xin chào, <strong>{{ session.ho_ten }}</strong>
  </div>
  <a class="btn btn-danger" href="{{ url_for('auth.dang_xuat') }}">Đăng xuất</a>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card__header card__header--row">
    <div>
        <h1 class="h1">Danh sách lịch hẹn</h1>
        <p class="muted">Quản lý và duyệt lịch khám bệnh</p>
    </div>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Mã số</th>
          <th>Thời gian</th>
          <th>Bệnh nhân</th>
          <th>Thông tin</th>
          {% if session.vai_tro == 'ADMIN' %}
            <th>Bác sĩ phụ trách</th>
          {% endif %}
          <th>Trạng thái</th>
          <th class="t-center">Hành động</th>
        </tr>
      </thead>
      <tbody>
        {% if ds_lich_hen %}
            {% for lh in ds_lich_hen %}
            <tr class="t-center">
              <td>{{ lh.LichHenID }}</td>
              <td>
                <div class="text-bold">{{ lh.GioKham }}</div>
                <div class="muted">{{ lh.NgayKham }}</div>
              </td>
              <td>
                <div class="text-bold">{{ lh.TenBenhNhan }}</div>
                <div class="text-sm muted">
                    {{ lh.GioiTinh }} - {{ lh.NgaySinh }}
                </div>
              </td>
              <td style="max-width: 200px;">
                {% if lh.LyDoKham %}
                    {{ lh.LyDoKham }}
                {% else %}
                    <span class="muted">-- Không có lý do --</span>
                {% endif %}
              </td>
              
              {% if session.vai_tro == 'ADMIN' %}
                <td>{{ lh.TenBacSi }}</td>
              {% endif %}

              <td>
                <span class="badge badge--{{ lh.TrangThai }}">
                  {% if lh.TrangThai == 'CHO_XAC_NHAN' %} Chờ xác nhận
                  {% elif lh.TrangThai == 'DA_XAC_NHAN' %} Đã duyệt
                  {% elif lh.TrangThai == 'DA_KHAM' %} Đã khám
                  {% elif lh.TrangThai == 'HUY' %} Đã hủy
                  {% elif lh.TrangThai == 'VANG_MAT' %} Vắng mặt 
                  {% else %} {{ lh.TrangThai }}
                  {% endif %}
                </span>
              </td>
              <td class="t-center">
                <div class="d-flex gap-5" style="justify-content: center;">
                    
                    {# Nút DUYỆT #}
                    {% if lh.TrangThai == 'CHO_XAC_NHAN' %}
                    <form method="POST" action="{{ url_for('bac_si.cap_nhat_trang_thai', lich_hen_id=lh.LichHenID, trang_thai='DA_XAC_NHAN') }}">
                        <button type="submit" class="btn btn-primary btn-sm">Duyệt</button>
                    </form>
                    {% endif %}

                    {# Nút HOÀN THÀNH hoặc VẮNG MẶT #}
                    {% if lh.TrangThai == 'DA_XAC_NHAN' %}
                        <button type="button" 
                                class="btn btn-outline btn-sm" 
                                style="color: var(--green); border-color: var(--green);"
                                onclick="moFormKham('{{ lh.LichHenID }}', '{{ lh.TenBenhNhan }}')">
                            Khám
                        </button>

                        <form method="POST" action="{{ url_for('bac_si.cap_nhat_trang_thai', lich_hen_id=lh.LichHenID, trang_thai='VANG_MAT') }}" onsubmit="return confirm('Xác nhận bệnh nhân vắng mặt?');" style="display: inline;">
                            <button type="submit" class="btn btn-outline btn-sm" style="color: #475569; border-color: #cbd5e1;">
                                Vắng mặt
                            </button>
                        </form>
                    {% endif %}
                    
                    {# Nút HỦY #}
                    {% if lh.TrangThai in ['CHO_XAC_NHAN', 'DA_XAC_NHAN'] %}
                    <form method="POST" action="{{ url_for('bac_si.cap_nhat_trang_thai', lich_hen_id=lh.LichHenID, trang_thai='HUY') }}" onsubmit="return confirm('Bạn chắc chắn muốn hủy lịch này?');">
                        <button type="submit" class="btn btn-ghost btn-sm" style="color: var(--red);">Hủy</button>
                    </form>
                    {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="7" class="t-center muted" style="padding: 30px;">
                    Chưa có lịch hẹn nào.
                </td>
            </tr>
        {% endif %}
      </tbody>
    </table>

    <div id="modalKham" class="modal">
      <div class="card modal-content">
          <span class="modal-close" onclick="dongModal()">&times;</span>
          
          <h2 class="h1 mb-15" style="font-size: 20px;">Kết quả khám bệnh</h2>
          <p class="muted mb-20">Nhập chẩn đoán và toa thuốc cho bệnh nhân: <strong id="modalTenBN"></strong></p>

          <form action="{{ url_for('bac_si.luu_ket_qua_kham') }}" method="POST">
              <input type="hidden" name="lich_hen_id" id="modalLichHenID">

              <div class="field">
                  <label class="label">Chẩn đoán / Kết luận</label>
                  <textarea class="input" name="chan_doan" rows="3" required placeholder="Ví dụ: Viêm họng cấp..."></textarea>
              </div>

              <div class="field">
                  <label class="label">Toa thuốc / Chỉ định</label>
                  <textarea class="input" name="toa_thuoc" rows="4" required placeholder="Ví dụ: Panadol 500mg (2 viên/ngày)..."></textarea>
              </div>

              <div class="d-flex gap-10 mt-15">
                  <button type="submit" class="btn btn-primary" style="flex: 1;">Lưu & Hoàn thành</button>
                  <button type="button" class="btn btn-outline" onclick="dongModal()" style="flex: 1;">Đóng</button>
              </div>
          </form>
      </div>
  </div>

  <script>
      function moFormKham(id, tenBenhNhan) {
          document.getElementById('modalLichHenID').value = id;
          document.getElementById('modalTenBN').innerText = tenBenhNhan;
          document.getElementById('modalKham').style.display = 'block';
      }
      
      function dongModal() {
          document.getElementById('modalKham').style.display = 'none';
      }

      // Đóng modal khi click ra ngoài
      window.onclick = function(event) {
          if (event.target == document.getElementById('modalKham')) {
              dongModal();
          }
      }
  </script>
  </div>
</div>
{% endblock %}